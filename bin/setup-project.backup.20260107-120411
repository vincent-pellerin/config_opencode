#!/bin/bash
set -e

# OpenCode Project Setup Script v2.0
# Creates new project with COMPLETE OpenCode configuration
# Includes: agents, commands, workflows, context, templates

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_header() {
    echo -e "${BLUE}=== $1 ===${NC}"
}

print_section() {
    echo -e "${CYAN}--- $1 ---${NC}"
}

# Function to show usage
show_usage() {
    cat << EOF
Usage: setup-project [OPTIONS] PROJECT_NAME

Setup a new project with COMPLETE OpenCode configuration including
agents, commands, workflows, and context files.

OPTIONS:
    -d, --directory DIR         Project directory (default: ~/dev/PROJECT_NAME)
    -t, --type TYPE             Project type (python|node|go|rust|generic)
    -f, --framework FRAMEWORK   Framework (django|fastapi|react|nextjs|etc)
    -b, --build-system          Run /build-context-system after setup (interactive)
    -s, --skip-templates        Skip generating templates (use existing .opencode)
    -h, --help                  Show this help message

EXAMPLES:
    setup-project my-api --type python --framework fastapi
    setup-project my-app --type node --framework react --build-system
    setup-project data-pipeline --type python
    setup-project my-project --directory /custom/path

FEATURES:
    âœ… Creates complete .opencode/ structure
    âœ… Generates orchestrator + subagents
    âœ… Creates custom commands
    âœ… Sets up workflows
    âœ… Configures context files
    âœ… Optional: Run interactive system builder

EOF
}

# Default values
PROJECT_DIR=""
PROJECT_TYPE="generic"
FRAMEWORK=""
PROJECT_NAME=""
BUILD_SYSTEM=false
SKIP_TEMPLATES=false

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--directory)
            PROJECT_DIR="$2"
            shift 2
            ;;
        -t|--type)
            PROJECT_TYPE="$2"
            shift 2
            ;;
        -f|--framework)
            FRAMEWORK="$2"
            shift 2
            ;;
        -b|--build-system)
            BUILD_SYSTEM=true
            shift
            ;;
        -s|--skip-templates)
            SKIP_TEMPLATES=true
            shift
            ;;
        -h|--help)
            show_usage
            exit 0
            ;;
        -*)
            print_error "Unknown option $1"
            show_usage
            exit 1
            ;;
        *)
            if [[ -z "$PROJECT_NAME" ]]; then
                PROJECT_NAME="$1"
            else
                print_error "Multiple project names provided"
                show_usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate required arguments
if [[ -z "$PROJECT_NAME" ]]; then
    print_error "Project name is required"
    show_usage
    exit 1
fi

# Set default project directory if not provided
if [[ -z "$PROJECT_DIR" ]]; then
    PROJECT_DIR="$HOME/dev/$PROJECT_NAME"
fi

# Validate project type
case $PROJECT_TYPE in
    python|node|go|rust|generic)
        ;;
    *)
        print_error "Invalid project type: $PROJECT_TYPE"
        print_error "Valid types: python, node, go, rust, generic"
        exit 1
        ;;
esac

# Slugify project name for file names
PROJECT_NAME_SLUG=$(echo "$PROJECT_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr '_' '-')

print_header "OpenCode Project Setup v2.0"
print_status "Project name: $PROJECT_NAME"
print_status "Project directory: $PROJECT_DIR"
print_status "Project type: $PROJECT_TYPE"
print_status "Architecture: COMPLETE (.opencode with agents/commands/workflows)"
if [[ "$BUILD_SYSTEM" == "true" ]]; then
    print_status "System Builder: âœ… Will run after setup"
fi

# Check if directory already exists
if [[ -d "$PROJECT_DIR" ]]; then
    print_warning "Directory $PROJECT_DIR already exists"
    read -p "Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_status "Aborted"
        exit 0
    fi
fi

# Create project directory
print_status "Creating project directory..."
mkdir -p "$PROJECT_DIR"
cd "$PROJECT_DIR"

# ============================================================================
# PART 1: Copy .gitignore
# ============================================================================
print_section "Setting up .gitignore"
cp ~/.opencode/templates/project/.gitignore .
print_status "Created .gitignore with .opencode/ ignored"

# ============================================================================
# PART 2: Create complete .opencode/ structure
# ============================================================================
print_section "Creating complete .opencode/ structure"

# Create all directories
mkdir -p .opencode/{agent/subagents,command,context/{domain,processes,standards,templates},workflows}
print_status "Created directory structure"

# ============================================================================
# PART 3: Generate orchestrator agent
# ============================================================================
print_section "Generating orchestrator agent"

cat > ".opencode/agent/${PROJECT_NAME_SLUG}-orchestrator.md" << 'ORCHESTRATOR'
<!-- Agent: PROJECT_NAME-orchestrator | Domain: PROJECT_TYPE | Priority: high -->
---
id: PROJECT_NAME-orchestrator
name: PROJECT_NAME Orchestrator
description: "Main orchestrator for PROJECT_NAME project"
category: local
type: orchestrator
version: 1.0.0
author: vincent
mode: primary
temperature: 0.2
tools:
  read: true
  write: true
  edit: true
  bash: true
  task: true
---

# PROJECT_NAME Orchestrator

<context>
  <system_context>
    AI-powered orchestrator for PROJECT_NAME project
  </system_context>
  <domain_context>
    PROJECT_DESCRIPTION
  </domain_context>
  <task_context>
    Coordinate workflows and delegate to specialized subagents
  </task_context>
  <execution_context>
    Manages PROJECT_NAME-specific tasks following established patterns
  </execution_context>
</context>

<role>
  PROJECT_NAME Specialist expert in DOMAIN_KEYWORDS
</role>

<task>
  Orchestrate PROJECT_NAME workflows:
  1. Analyze requests and determine approach
  2. Execute or delegate to specialized subagents
  3. Validate outputs against quality criteria
  4. Handle errors with appropriate recovery strategies
</task>

<workflow_execution>
  <stage id="1" name="AnalyzeRequest">
    <action>Analyze user request and determine approach</action>
    <process>
      1. Parse request type and complexity
      2. Identify required context files
      3. Determine if delegation needed
      4. Load relevant context
    </process>
    <outputs>
      analysis: { type, complexity, context_needed[], delegation_required }
    </outputs>
  </stage>

  <stage id="2" name="ExecuteTask">
    <action>Execute or delegate task</action>
    <prerequisites>Request analyzed</prerequisites>
    <process>
      1. If simple: execute directly with context
      2. If complex: delegate to appropriate subagent
      3. Apply project-specific patterns
      4. Track progress and metrics
    </process>
  </stage>

  <stage id="3" name="ValidateOutput">
    <action>Validate results against quality criteria</action>
    <prerequisites>Task executed</prerequisites>
    <process>
      1. Check output quality gates
      2. Verify completeness
      3. Handle errors or request fixes
      4. Summarize completed work
    </process>
  </stage>
</workflow_execution>

<context_load>
  @~/.opencode/context/core/standards/code.md
  @context/domain/PROJECT_NAME-concepts.md
  @context/processes/PROJECT_WORKFLOW.md
  @context/standards/quality-criteria.md
</context_load>

<routing>
  <delegate to="@subagents/SUBAGENT_1" when="[Condition]" />
  <delegate to="@subagents/SUBAGENT_2" when="[Condition]" />
</routing>

<quality_gates>
  <gate id="output_quality">Output meets quality criteria from context/standards/</gate>
  <gate id="context_compliance">Follows project patterns and standards</gate>
  <gate id="error_handling">Errors handled appropriately with recovery</gate>
</quality_gates>

<error_handling>
  <retryable_errors>
    - Network timeouts (retry 3x with backoff)
    - API rate limits (wait and retry)
    - Transient failures (retry with longer timeout)
  </retryable_errors>
  <non_retryable_errors>
    - Invalid input (return error immediately)
    - Missing context (load context, retry once)
    - Permission denied (fail with explanation)
  </non_retryable_errors>
</error_handling>
</parameter>
ORCHESTRATOR

# Replace placeholders
sed -i "s/PROJECT_NAME/$PROJECT_NAME/g" ".opencode/agent/${PROJECT_NAME_SLUG}-orchestrator.md"
sed -i "s/PROJECT_TYPE/$PROJECT_TYPE/g" ".opencode/agent/${PROJECT_NAME_SLUG}-orchestrator.md"
sed -i "s/PROJECT_DESCRIPTION/[TODO: Add project description]/g" ".opencode/agent/${PROJECT_NAME_SLUG}-orchestrator.md"
sed -i "s/DOMAIN_KEYWORDS/$PROJECT_TYPE, automation, workflows/g" ".opencode/agent/${PROJECT_NAME_SLUG}-orchestrator.md"
sed -i "s/PROJECT_WORKFLOW/${PROJECT_TYPE}-workflow/g" ".opencode/agent/${PROJECT_NAME_SLUG}-orchestrator.md"
sed -i "s/SUBAGENT_1/${PROJECT_TYPE}-processor/g" ".opencode/agent/${PROJECT_NAME_SLUG}-orchestrator.md"
sed -i "s/SUBAGENT_2/${PROJECT_TYPE}-validator/g" ".opencode/agent/${PROJECT_NAME_SLUG}-orchestrator.md"
sed -i "s/PROJECT_NAME_SLUG/$PROJECT_NAME_SLUG/g" ".opencode/agent/${PROJECT_NAME_SLUG}-orchestrator.md"

print_status "Created orchestrator: ${PROJECT_NAME_SLUG}-orchestrator.md"

# ============================================================================
# PART 4: Generate subagents
# ============================================================================
print_section "Generating subagents"

# Subagent 1: Processor
cat > ".opencode/agent/subagents/${PROJECT_TYPE}-processor.md" << 'SUBAGENT'
<!-- Subagent: PROJECT_TYPE-processor -->
---
id: PROJECT_TYPE-processor
name: PROJECT_TYPE Processor
description: "Specialized agent for processing PROJECT_TYPE data"
category: subagents
type: subagent
version: 1.0.0
mode: subagent
temperature: 0.1
---

# PROJECT_TYPE Processor

<context>
  <specialist_domain>PROJECT_TYPE data processing</specialist_domain>
  <task_scope>Process and transform PROJECT_TYPE data efficiently</task_scope>
  <integration>Works with PROJECT_NAME-orchestrator</integration>
</context>

<role>
  PROJECT_TYPE Processing Specialist expert in data transformation
</role>

<task>
  Process PROJECT_TYPE data:
  1. Receive and validate input data
  2. Apply transformation rules
  3. Validate output quality
  4. Return structured results
</task>

<inputs_required>
  input_data: Raw input to process
  options: Processing options (optional)
</inputs_required>

<outputs>
  processed_data: Transformed data
  metadata: Processing metadata
</outputs>

<process_flow>
  <step_1>
    <action>Validate and prepare input</action>
    <process>
      1. Check required fields
      2. Normalize data format
      3. Handle edge cases
    </process>
  </step_1>

  <step_2>
    <action>Apply transformations</action>
    <process>
      1. Load transformation rules
      2. Apply in sequence
      3. Track changes
    </process>
  </step_2>

  <step_3>
    <action>Validate output</action>
    <process>
      1. Check output quality
      2. Verify completeness
      3. Return results
    </process>
  </step_3>
</process_flow>

<context_load>
  @context/domain/PROJECT_NAME-concepts.md
  @context/standards/quality-criteria.md
</context_load>

<quality_criteria>
  - Output completeness: 100%
  - Transformation accuracy: > 95%
  - Processing time: < expected
</quality_criteria>
</subagent>

# Subagent 2: Validator
cat > ".opencode/agent/subagents/${PROJECT_TYPE}-validator.md" << 'SUBAGENT'
<!-- Subagent: PROJECT_TYPE-validator -->
---
id: PROJECT_TYPE-validator
name: PROJECT_TYPE Validator
description: "Specialized agent for validating PROJECT_TYPE outputs"
category: subagents
type: subagent
version: 1.0.0
mode: subagent
temperature: 0.1
---

# PROJECT_TYPE Validator

<context>
  <specialist_domain>PROJECT_TYPE quality validation</specialist_domain>
  <task_scope>Validate outputs against quality criteria</task_scope>
  <integration>Works with PROJECT_NAME-orchestrator</integration>
</context>

<role>
  Quality Assurance Specialist for PROJECT_TYPE
</role>

<task>
  Validate PROJECT_TYPE outputs:
  1. Check against quality criteria
  2. Verify completeness and accuracy
  3. Provide validation report
  4. Suggest improvements if needed
</task>

<inputs_required>
  output: Data to validate
  criteria: Validation criteria (optional)
</inputs_required>

<outputs>
  is_valid: Boolean validation result
  issues: List of issues found
  score: Quality score (0-100)
  suggestions: Improvement recommendations
</outputs>

<process_flow>
  <step_1>
    <action>Load validation criteria</action>
    <process>
      1. Load from context/standards/quality-criteria.md
      2. Apply project-specific rules
    </process>
  </step_1>

  <step_2>
    <action>Run validation checks</action>
    <process>
      1. Check completeness
      2. Check accuracy
      3. Check consistency
      4. Check formatting
    </process>
  </step_2>

  <step_3>
    <action>Generate report</action>
    <process>
      1. Compile issues list
      2. Calculate quality score
      3. Provide suggestions
    </process>
  </step_2>
</process_flow>

<context_load>
  @context/standards/quality-criteria.md
</context_load>

<quality_criteria>
  - Issue detection: > 95%
  - False positive rate: < 5%
  - Clear suggestions provided
</quality_criteria>
</subagent>

# Substitute variables for subagents
sed -i "s/PROJECT_NAME/$PROJECT_NAME/g" ".opencode/agent/subagents/${PROJECT_TYPE}-processor.md"
sed -i "s/PROJECT_TYPE/$PROJECT_TYPE/g" ".opencode/agent/subagents/${PROJECT_TYPE}-validator.md"
sed -i "s/PROJECT_NAME/$PROJECT_NAME/g" ".opencode/agent/subagents/${PROJECT_TYPE}-validator.md"

print_status "Created subagents: ${PROJECT_TYPE}-processor.md, ${PROJECT_TYPE}-validator.md"

# ============================================================================
# PART 5: Generate commands
# ============================================================================
print_section "Generating commands"

# Command 1: Process
cat > ".opencode/command/${PROJECT_TYPE}-process.md" << 'COMMAND'
---
description: "Process PROJECT_TYPE data through the pipeline"
syntax: /PROJECT_TYPE-process [OPTIONS]
examples:
  - "/PROJECT_TYPE-process"
  - "/PROJECT_TYPE-process --input file.txt"
---

# PROJECT_TYPE Process Command

Process PROJECT_TYPE data through the complete pipeline.

## Usage

```bash
/PROJECT_TYPE-process [OPTIONS]
```

## Parameters

| Parameter | Description |
|-----------|-------------|
| `--input` | Input file or data |
| `--output` | Output location (optional) |
| `--validate` | Run validation only |

## Examples

```bash
# Process with default settings
/PROJECT_TYPE-process

# Process specific input
/PROJECT_TYPE-process --input data.json
```

## Output

Returns processing results and quality metrics.
</command>

# Command 2: Validate
cat > ".opencode/command/${PROJECT_TYPE}-validate.md" << 'COMMAND'
---
description: "Validate PROJECT_TYPE outputs"
syntax: /PROJECT_TYPE-validate <output>
examples:
  - "/PROJECT_TYPE-validate output.json"
---

# PROJECT_TYPE Validate Command

Validate PROJECT_TYPE output against quality criteria.

## Usage

```bash
/PROJECT_TYPE-validate <output>
```

## Parameters

| Parameter | Description |
|-----------|-------------|
| `output` | File or data to validate |

## Examples

```bash
# Validate output file
/PROJECT_TYPE-validate output.json

# Validate with details
/PROJECT_TYPE-validate output.json --detailed
```

## Output

Validation report with issues and suggestions.
</command

sed -i "s/PROJECT_TYPE/$PROJECT_TYPE/g" ".opencode/command/${PROJECT_TYPE}-process.md"
sed -i "s/PROJECT_TYPE/$PROJECT_TYPE/g" ".opencode/command/${PROJECT_TYPE}-validate.md"

print_status "Created commands: ${PROJECT_TYPE}-process.md, ${PROJECT_TYPE}-validate.md"

# ============================================================================
# PART 6: Generate workflows
# ============================================================================
print_section "Generating workflows"

cat > ".opencode/workflows/${PROJECT_TYPE}-pipeline.md" << 'WORKFLOW'
# PROJECT_TYPE Pipeline

## Purpose

Process PROJECT_TYPE data through the complete workflow.

## Trigger

`/PROJECT_TYPE-process`

## Stages

| Stage | Agent | Success Criteria |
|-------|-------|------------------|
| 1. Input | orchestrator | Valid input received |
| 2. Process | ${PROJECT_TYPE}-processor | Data transformed |
| 3. Validate | ${PROJECT_TYPE}-validator | Quality gates passed |

## Context Dependencies

```yaml
context:
  - @~/.opencode/context/core/standards/code.md
  - @context/domain/PROJECT_NAME-concepts.md
  - @context/processes/${PROJECT_TYPE}-process.md
  - @context/standards/quality-criteria.md
```

## Input Schema

```json
{
  "type": "object",
  "properties": {
    "input": { "type": "string" }
  }
}
```

## Output Schema

```json
{
  "type": "object",
  "properties": {
    "success": { "type": "boolean" },
    "output": { "type": "object" },
    "quality_score": { "type": "number" }
  }
}
```
</WORKFLOW

sed -i "s/PROJECT_TYPE/$PROJECT_TYPE/g" ".opencode/workflows/${PROJECT_TYPE}-pipeline.md"
sed -i "s/PROJECT_NAME/$PROJECT_NAME/g" ".opencode/workflows/${PROJECT_TYPE}-pipeline.md"

print_status "Created workflow: ${PROJECT_TYPE}-pipeline.md"

# ============================================================================
# PART 7: Generate context files
# ============================================================================
print_section "Generating context files"

# Domain concepts
cat > ".opencode/context/domain/${PROJECT_NAME_SLUG}-concepts.md" << 'CONTEXT'
# PROJECT_NAME Concepts

## Global Context References

**ALWAYS load these global contexts first:**
- `@~/.opencode/context/core/standards/code.md` - Universal code standards
- `@~/.opencode/context/core/workflows/delegation.md` - Task delegation patterns

## Core Concepts

### Key Terms

| Term | Definition |
|------|------------|
| [Term] | [Definition] |

### Workflow

```
Input â†’ Process â†’ Validate â†’ Output
```

### Quality Standards

- Completeness: All required fields present
- Accuracy: Data is correct
- Performance: Efficient execution

## Common Errors

| Error | Solution |
|-------|----------|
| [Error] | [Solution] |
</CONTEXT

# Process documentation
cat > ".opencode/context/processes/${PROJECT_TYPE}-process.md" << 'CONTEXT'
# PROJECT_TYPE Process

## Overview

Process PROJECT_TYPE data efficiently.

## Prerequisites

- [ ] Prerequisites met
- [ ] Context loaded

## Stage 1: Input

Validate and prepare input data.

## Stage 2: Process

Apply transformations.

## Stage 3: Validate

Check quality gates.

## Complete Example

```python
# Process data
result = process_pipeline(input)
```
</CONTEXT

# Quality criteria
cat > ".opencode/context/standards/quality-criteria.md" << 'CONTEXT'
# Quality Criteria

## Overview

Quality standards for PROJECT_NAME outputs.

## Validation Rules

```python
def validate_output(output):
    errors = []
    for field in required_fields:
        if field not in output:
            errors.append(f"Missing: {field}")
    return {"is_valid": len(errors) == 0, "errors": errors}
```

## Quality Scores

| Score | Level |
|-------|-------|
| > 90% | Excellent |
| 75-90% | Good |
| 60-75% | Acceptable |
| < 60% | Needs Improvement |

## Code Quality

- Follow global standards
- Type hints required
- Error handling specific
</CONTEXT

sed -i "s/PROJECT_NAME/$PROJECT_NAME/g" ".opencode/context/domain/${PROJECT_NAME_SLUG}-concepts.md"
sed -i "s/PROJECT_TYPE/$PROJECT_TYPE/g" ".opencode/context/domain/${PROJECT_NAME_SLUG}-concepts.md"
sed -i "s/PROJECT_NAME/$PROJECT_NAME/g" ".opencode/context/processes/${PROJECT_TYPE}-process.md"
sed -i "s/PROJECT_TYPE/$PROJECT_TYPE/g" ".opencode/context/processes/${PROJECT_TYPE}-process.md"
sed -i "s/PROJECT_NAME/$PROJECT_NAME/g" ".opencode/context/standards/quality-criteria.md"

print_status "Created context files"

# Copy existing template files
for template_file in ~/.opencode/templates/project/.opencode/context/*.md; do
    if [[ -f "$template_file" ]]; then
        filename=$(basename "$template_file")
        # Skip if we already created these
        if [[ ! -f ".opencode/context/$filename" ]]; then
            cp "$template_file" ".opencode/context/$filename"
            print_status "Copied template: $filename"
        fi
    fi
done

# ============================================================================
# PART 8: Create basic project structure based on type
# ============================================================================
print_section "Creating project structure"

case $PROJECT_TYPE in
    python)
        mkdir -p src tests config docs scripts
        cat > requirements.txt << 'EOF'
# Core dependencies
fastapi>=0.104.0
uvicorn[standard]>=0.24.0
pydantic>=2.5.0

# Development dependencies
pytest>=7.4.0
black>=23.0.0
isort>=5.12.0
ruff>=0.1.0
mypy>=1.7.0
EOF
        
        cat > pyproject.toml << EOF
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "$PROJECT_NAME"
version = "0.1.0"
description = ""
authors = [{name = "Vincent", email = "vincent@example.com"}]
dependencies = [
    "fastapi>=0.104.0",
    "uvicorn[standard]>=0.24.0",
    "pydantic>=2.5.0",
]

[project.optional-dependencies]
dev = [
    "pytest>=7.4.0",
    "black>=23.0.0",
    "isort>=5.12.0",
    "ruff>=0.1.0",
    "mypy>=1.7.0",
]

[tool.black]
line-length = 100
target-version = ["py312"]

[tool.isort]
profile = "black"
line_length = 100

[tool.ruff]
line-length = 100
select = ["E", "F", "W", "I"]

[tool.mypy]
python_version = "3.12"
warn_return_any = true
warn_unused_configs = true
EOF
        
        cat > src/main.py << EOF
"""
$PROJECT_NAME - Main application module
"""
from fastapi import FastAPI

app = FastAPI(title="$PROJECT_NAME", version="0.1.0")


@app.get("/")
async def root():
    """Root endpoint"""
    return {"message": "Hello from $PROJECT_NAME!"}


@app.get("/health")
async def health_check():
    """Health check endpoint"""
    return {"status": "healthy"}


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
EOF
        ;;
        
    node)
        mkdir -p src tests config docs scripts
        cat > package.json << EOF
{
  "name": "$PROJECT_NAME",
  "version": "0.1.0",
  "description": "",
  "main": "src/index.js",
  "scripts": {
    "dev": "nodemon src/index.js",
    "start": "node src/index.js",
    "test": "jest"
  },
  "dependencies": {
    "express": "^4.18.0"
  },
  "devDependencies": {
    "jest": "^29.0.0",
    "nodemon": "^3.0.0"
  }
}
EOF
        
        cat > src/index.js << EOF
const express = require('express');
const app = express();
const PORT = process.env.PORT || 3000;

app.use(express.json());

app.get('/', (req, res) => {
    res.json({ message: 'Hello from $PROJECT_NAME!' });
});

app.get('/health', (req, res) => {
    res.json({ status: 'healthy' });
});

app.listen(PORT, () => {
    console.log(\`$PROJECT_NAME server running on port \${PORT}\`);
});
EOF
        ;;
        
    *)
        mkdir -p src tests config docs scripts
        ;;
esac

# ============================================================================
# PART 9: Create README
# ============================================================================
print_section "Creating README"

cat > README.md << EOF
# $PROJECT_NAME

## OpenCode Configuration

This project uses OpenCode for enhanced development with a complete local configuration.

### Local Configuration

\`\`\`
.opencode/
â”œâ”€â”€ agent/
â”‚   â”œâ”€â”€ ${PROJECT_NAME_SLUG}-orchestrator.md  # Main orchestrator
â”‚   â””â”€â”€ subagents/
â”‚       â”œâ”€â”€ ${PROJECT_TYPE}-processor.md      # Data processor
â”‚       â””â”€â”€ ${PROJECT_TYPE}-validator.md      # Quality validator
â”œâ”€â”€ command/
â”‚   â”œâ”€â”€ ${PROJECT_TYPE}-process.md            # Process command
â”‚   â””â”€â”€ ${PROJECT_TYPE}-validate.md           # Validate command
â”œâ”€â”€ context/
â”‚   â”œâ”€â”€ domain/                               # Domain concepts
â”‚   â”œâ”€â”€ processes/                            # Process documentation
â”‚   â””â”€â”€ standards/                            # Quality criteria
â””â”€â”€ workflows/
    â””â”€â”€ ${PROJECT_TYPE}-pipeline.md           # Main workflow
\`\`\`

### Global Configuration

Global OpenCode standards are automatically loaded from \`~/.opencode/\`.

## Commands

\`\`\`bash
# Process data
/${PROJECT_TYPE}-process --input data.json

# Validate output
/${PROJECT_TYPE}-validate output.json
\`\`\`

## Development

### Setup
1. Install dependencies
2. Configure environment
3. Run development server

### Testing
\`\`\`bash
# Run tests
pytest tests/

# Linting
ruff check .
\`\`\`

## Architecture

See \`.opencode/\` directory for complete architecture documentation.
EOF

# ============================================================================
# PART 10: Summary
# ============================================================================
print_header "Setup Complete!"
print_status "Project created at: $PROJECT_DIR"
print_status "OpenCode configuration: âœ… COMPLETE"
print_status "Files created:"
echo "   â”œâ”€â”€ .opencode/agent/ (1 orchestrator + 2 subagents)"
echo "   â”œâ”€â”€ .opencode/command/ (2 commands)"
echo "   â”œâ”€â”€ .opencode/context/ (domain, processes, standards)"
echo "   â”œâ”€â”€ .opencode/workflows/ (1 workflow)"
echo "   â”œâ”€â”€ src/, tests/, config/, docs/"
echo "   â””â”€â”€ README.md"

# ============================================================================
# PART 11: Offer to run system builder
# ============================================================================
if [[ "$BUILD_SYSTEM" == "true" ]]; then
    print_section "Running OpenCode System Builder"
    print_status "Starting interactive configuration..."
    
    # Run the build-context-system command
    if command -v opencode &> /dev/null; then
        opencode --command build-context-system -- "$PROJECT_NAME" --type "$PROJECT_TYPE"
    else
        print_warning "OpenCode CLI not found. Skipping system builder."
        print_info "You can run it later with: opencode --command build-context-system"
    fi
else
    echo
    print_header "Next Steps"
    echo "1. cd $PROJECT_DIR"
    echo "2. Customize .opencode/context/ files with project-specific content"
    echo "3. Update .opencode/agent/ with actual agent logic"
    echo "4. Run: git init"
    echo "5. Start developing!"
    
    echo
    print_info "Optional: Run interactive system builder for complete customization:"
    echo "   opencode --command build-context-system -- $PROJECT_NAME --type $PROJECT_TYPE"
    echo ""
    print_status "Happy coding! ðŸš€"
fi

