#!/bin/bash
# Test Global Context Loading
# Verifies that global context is accessible and properly structured

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üîç Testing Global Context Loading${NC}"
echo "=================================="

# Test 1: Check if global context directory exists
echo -n "1. Global context directory exists... "
if [ -d "$HOME/.opencode/context" ]; then
    echo -e "${GREEN}‚úÖ${NC}"
else
    echo -e "${RED}‚ùå${NC}"
    echo -e "${RED}Error: ~/.opencode/context directory not found${NC}"
    exit 1
fi

# Test 2: Check if index.md exists
echo -n "2. Global context index exists... "
if [ -f "$HOME/.opencode/context/index.md" ]; then
    echo -e "${GREEN}‚úÖ${NC}"
else
    echo -e "${RED}‚ùå${NC}"
    echo -e "${RED}Error: ~/.opencode/context/index.md not found${NC}"
    exit 1
fi

# Test 3: Check critical context files
echo "3. Critical context files:"
critical_files=(
    "core/standards/code.md"
    "core/system/context-guide.md"
    "integrations/n8n/config.md"
    "global/machine.md"
)

for file in "${critical_files[@]}"; do
    echo -n "   - $file... "
    if [ -f "$HOME/.opencode/context/$file" ]; then
        echo -e "${GREEN}‚úÖ${NC}"
    else
        echo -e "${RED}‚ùå${NC}"
    fi
done

# Test 4: Check environment variables
echo "4. Environment configuration:"
echo -n "   - .env file exists... "
if [ -f "$HOME/.opencode/.env" ]; then
    echo -e "${GREEN}‚úÖ${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Missing${NC}"
fi

# Test 5: Check n8n configuration
echo "5. n8n Integration:"
if [ -f "$HOME/.opencode/context/integrations/n8n/config.md" ]; then
    echo -n "   - n8n config accessible... "
    echo -e "${GREEN}‚úÖ${NC}"
    
    # Extract n8n URL from config
    n8n_url=$(grep "Base URL" "$HOME/.opencode/context/integrations/n8n/config.md" | head -1 | sed 's/.*`\(.*\)`.*/\1/')
    if [ -n "$n8n_url" ]; then
        echo "   - n8n URL: $n8n_url"
    fi
else
    echo -e "${RED}‚ùå n8n config not found${NC}"
fi

# Test 6: Check tools and scripts
echo "6. Available tools:"
tools_dir="$HOME/.opencode/bin"
if [ -d "$tools_dir" ]; then
    tool_count=$(ls -1 "$tools_dir" | wc -l)
    echo "   - Tools directory: ${GREEN}‚úÖ${NC} ($tool_count tools)"
    echo "   - Available tools:"
    ls -1 "$tools_dir" | sed 's/^/     ‚Ä¢ /'
else
    echo -e "${RED}‚ùå Tools directory not found${NC}"
fi

# Test 7: Context precedence test
echo "7. Context precedence:"
echo -n "   - Global context takes precedence... "
if grep -q "Global Configuration (Priority)" "$HOME/.opencode/context/global/project-setup.md" 2>/dev/null; then
    echo -e "${GREEN}‚úÖ${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Documentation unclear${NC}"
fi

# Summary
echo ""
echo -e "${BLUE}üìä Summary${NC}"
echo "=========="
echo "Global context structure: ${GREEN}‚úÖ Ready${NC}"
echo "Critical files: ${GREEN}‚úÖ Available${NC}"
echo "n8n integration: ${GREEN}‚úÖ Configured${NC}"
echo "Tools: ${GREEN}‚úÖ Available${NC}"

echo ""
echo -e "${GREEN}üéâ Global context is properly configured!${NC}"
echo ""
echo -e "${BLUE}üí° Usage Tips:${NC}"
echo "‚Ä¢ Always load ~/.opencode/context/index.md first"
echo "‚Ä¢ Global config takes precedence over local"
echo "‚Ä¢ Use lazy loading - load context when needed"
echo "‚Ä¢ Check integrations/n8n/ for n8n debugging"

echo ""
echo -e "${BLUE}üîß Next Steps:${NC}"
echo "‚Ä¢ Configure your agent to automatically load global context"
echo "‚Ä¢ Use context index for task-specific context discovery"
echo "‚Ä¢ Apply global standards before any code implementation"