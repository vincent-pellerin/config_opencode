#!/bin/bash
# OpenCode Structure Validation Tool
# Validates that files are in correct locations per OpenCode standards

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

OPENCODE_ROOT="$HOME/.opencode"
ERRORS=0
WARNINGS=0

echo -e "${BLUE}üîç OpenCode Structure Validation${NC}"
echo "=================================="

# Check if OpenCode directory exists
if [ ! -d "$OPENCODE_ROOT" ]; then
    echo -e "${RED}‚ùå OpenCode directory not found: $OPENCODE_ROOT${NC}"
    exit 1
fi

echo -e "\n${YELLOW}1. Checking directory structure...${NC}"

# Expected directories
expected_dirs=(
    "context"
    "bin" 
    "templates"
    "agent"
    "tool"
    "plugin"
    "command"
)

for dir in "${expected_dirs[@]}"; do
    if [ -d "$OPENCODE_ROOT/$dir" ]; then
        echo -e "   ${GREEN}‚úÖ $dir/${NC}"
    else
        echo -e "   ${YELLOW}‚ö†Ô∏è  $dir/ (optional)${NC}"
        ((WARNINGS++))
    fi
done

echo -e "\n${YELLOW}2. Validating file placement...${NC}"

# Check for executable files in context directories
echo -e "   Checking for executables in context/..."
if find "$OPENCODE_ROOT/context" -type f -executable 2>/dev/null | grep -q .; then
    echo -e "   ${RED}‚ùå Found executable files in context/ directories:${NC}"
    find "$OPENCODE_ROOT/context" -type f -executable 2>/dev/null | while read file; do
        echo -e "      ${RED}‚Ä¢ $file${NC}"
        ((ERRORS++))
    done
else
    echo -e "   ${GREEN}‚úÖ No executables in context/ directories${NC}"
fi

# Check for documentation in bin directory
echo -e "   Checking for documentation in bin/..."
if find "$OPENCODE_ROOT/bin" -name "*.md" 2>/dev/null | grep -q .; then
    echo -e "   ${RED}‚ùå Found markdown files in bin/ directory:${NC}"
    find "$OPENCODE_ROOT/bin" -name "*.md" 2>/dev/null | while read file; do
        echo -e "      ${RED}‚Ä¢ $file${NC}"
        ((ERRORS++))
    done
else
    echo -e "   ${GREEN}‚úÖ No documentation in bin/ directory${NC}"
fi

echo -e "\n${YELLOW}3. Checking naming conventions...${NC}"

# Check for spaces in filenames
echo -e "   Checking for spaces in filenames..."
if find "$OPENCODE_ROOT" -name "* *" 2>/dev/null | grep -q .; then
    echo -e "   ${RED}‚ùå Found files/directories with spaces:${NC}"
    find "$OPENCODE_ROOT" -name "* *" 2>/dev/null | while read file; do
        echo -e "      ${RED}‚Ä¢ $file${NC}"
        ((ERRORS++))
    done
else
    echo -e "   ${GREEN}‚úÖ No spaces in filenames${NC}"
fi

# Check for uppercase in filenames (should be kebab-case)
echo -e "   Checking naming conventions..."
problematic_files=$(find "$OPENCODE_ROOT" -name "*[A-Z]*" -not -path "*/node_modules/*" 2>/dev/null || true)
if [ -n "$problematic_files" ]; then
    echo -e "   ${YELLOW}‚ö†Ô∏è  Files with uppercase (prefer kebab-case):${NC}"
    echo "$problematic_files" | while read file; do
        echo -e "      ${YELLOW}‚Ä¢ $file${NC}"
        ((WARNINGS++))
    done
else
    echo -e "   ${GREEN}‚úÖ Naming conventions followed${NC}"
fi

echo -e "\n${YELLOW}4. Checking required files...${NC}"

# Check for essential files
essential_files=(
    "context/index.md"
    "context/core/system/context-guide.md"
    "context/core/standards/patterns.md"
)

for file in "${essential_files[@]}"; do
    if [ -f "$OPENCODE_ROOT/$file" ]; then
        echo -e "   ${GREEN}‚úÖ $file${NC}"
    else
        echo -e "   ${RED}‚ùå Missing: $file${NC}"
        ((ERRORS++))
    fi
done

echo -e "\n${YELLOW}5. Checking permissions...${NC}"

# Check that scripts in bin/ are executable
if [ -d "$OPENCODE_ROOT/bin" ]; then
    non_executable=$(find "$OPENCODE_ROOT/bin" -type f ! -executable 2>/dev/null || true)
    if [ -n "$non_executable" ]; then
        echo -e "   ${YELLOW}‚ö†Ô∏è  Non-executable files in bin/:${NC}"
        echo "$non_executable" | while read file; do
            echo -e "      ${YELLOW}‚Ä¢ $file${NC}"
            ((WARNINGS++))
        done
    else
        echo -e "   ${GREEN}‚úÖ All bin/ files are executable${NC}"
    fi
fi

echo -e "\n${YELLOW}6. Checking index consistency...${NC}"

# Check if index files exist and are up to date
if [ -f "$OPENCODE_ROOT/context/index.md" ]; then
    echo -e "   ${GREEN}‚úÖ Main index exists${NC}"
    
    # Check for orphaned context files not referenced in index
    # This is a simplified check - could be enhanced
    echo -e "   ${BLUE}‚ÑπÔ∏è  Index consistency check (manual review recommended)${NC}"
else
    echo -e "   ${RED}‚ùå Main index missing${NC}"
    ((ERRORS++))
fi

# Summary
echo -e "\n${BLUE}üìã Validation Summary${NC}"
echo "====================="

if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    echo -e "${GREEN}üéâ Perfect! Structure follows all OpenCode standards${NC}"
    exit 0
elif [ $ERRORS -eq 0 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Structure is valid with $WARNINGS warnings${NC}"
    echo -e "${BLUE}üí° Consider addressing warnings for optimal structure${NC}"
    exit 0
else
    echo -e "${RED}‚ùå Structure has $ERRORS errors and $WARNINGS warnings${NC}"
    echo -e "${BLUE}üîß Fix errors before proceeding with structural changes${NC}"
    exit 1
fi